"""Start and basic command handlers."""

import logging
from aiogram.types import Message
from src.config import settings
from src.bot.keyboards import get_main_menu
from src.storage.postgres import db
from sqlalchemy import text

logger = logging.getLogger(__name__)


async def cmd_start(message: Message):
    """Handle /start command."""
    # Whitelist check is handled by middleware
    welcome_text = (
        "üéØ <b>AAA TON GIFTS SCANNER</b>\n\n"
        "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤ —Ç–≤–æ—ë–º –ª–∏—á–Ω–æ–º —Å–∫–∞–Ω–µ –≥–∏—Ñ—Ç–æ–≤, –±—Ä–æ!\n\n"
        "–ë—É–¥—É –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Ç–µ–±–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ —Å–∞–º—ã–µ –∂–∏—Ä–Ω—ã–µ –¥–∏–ª—ã –ø–æ TON Gifts.\n\n"
        "<b>–§–∏—á–∏:</b>\n"
        "‚Ä¢ üî• –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –≥–æ—Ä—è—á–∏–µ –¥–∏–ª—ã\n"
        "‚Ä¢ üìä –£–º–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (ARP, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å)\n"
        "‚Ä¢ üñ§ –¢—Ä–µ–∫–∏–Ω–≥ Black Pack\n"
        "‚Ä¢ ‚è±Ô∏è –†—ã–Ω–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ —Ä–µ–∞–ª—Ç–∞–π–º–µ\n"
        "‚Ä¢ üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤ (5 —Å–ª–æ—ë–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)\n\n"
        "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
        "/help - –ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é\n"
        "/features - üî• –í–°–ï –§–ò–ß–ò –ò –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê\n"
        "/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä—ã–Ω–∫–∞\n"
        "/onchain - ‚õìÔ∏è On-chain NFT —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n"
        "–ì–æ—Ç–æ–≤ –ª–æ–≤–∏—Ç—å –¥–∏–ª—ã! –ü–æ–µ—Ö–∞–ª–∏ –Ω–∞—Ö—É–π! üíé"
    )

    await message.answer(welcome_text, parse_mode="HTML")


async def cmd_help(message: Message):
    """Handle /help command."""
    # Whitelist check is handled by middleware
    help_text = (
        "<b>üéØ AAA TON GIFTS SCANNER - –ü–û–ú–û–©–¨</b>\n\n"
        "<b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>\n"
        "1. –ú–æ–Ω–∏—Ç–æ—Ä—é –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ TON Gifts —Ä—ã–Ω–∫–µ –≤ —Ä–µ–∞–ª—Ç–∞–π–º–µ\n"
        "2. –°—á–∏—Ç–∞—é —É–º–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∏–ª–∞\n"
        "3. –®–ª—é —Ç–µ–±–µ –∞–ª–µ—Ä—Ç—ã –∫–æ–≥–¥–∞ –Ω–∞—Ö–æ–∂—É –ø—Ä–æ—Ñ–∏—Ç–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n\n"
        "<b>–ö–∞–∫ —á–∏—Ç–∞—Ç—å –∞–ª–µ—Ä—Ç—ã:</b>\n"
        "‚Ä¢ <b>–ü—Ä–æ—Ñ–∏—Ç %</b> - –ù–∞—Å–∫–æ–ª—å–∫–æ –Ω–∏–∂–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–π —Ü–µ–Ω—ã\n"
        "‚Ä¢ <b>–†–µ—Ñ–µ—Ä–µ–Ω—Å (ARP)</b> - –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–∞—è —Ü–µ–Ω–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑:\n"
        "  - 2-–≥–æ —Ñ–ª–æ—Ä–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Ñ–µ–π–∫–æ–≤—ã—Ö –ª–∏—Å—Ç–∏–Ω–≥–æ–≤)\n"
        "  - –ü–æ—Å–ª–µ–¥–Ω–∏—Ö –ø—Ä–æ–¥–∞–∂\n"
        "  - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏\n"
        "‚Ä¢ <b>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</b> - –ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö (–ø–æ –æ–±—ä—ë–º—É –ø—Ä–æ–¥–∞–∂)\n"
        "‚Ä¢ <b>–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</b> - –ù–∞—Å–∫–æ–ª—å–∫–æ –ª–µ–≥–∫–æ –ø—Ä–æ–¥–∞—Ç—å (—à–∫–∞–ª–∞ 0-10)\n"
        "‚Ä¢ <b>–ì–æ—Ä—è—á–µ—Å—Ç—å</b> - –£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä—ã–Ω–∫–∞\n\n"
        "<b>–ö–Ω–æ–ø–∫–∏ –≤ –∞–ª–µ—Ä—Ç–µ:</b>\n"
        "‚Ä¢ üéÅ –û–¢–ö–†–´–¢–¨ - –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∏—Ñ—Ç\n"
        "‚Ä¢ üîç TONNEL - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ Tonnel\n"
        "‚Ä¢ ‚≠ê –í –ò–ó–ë–†–ê–ù–ù–û–ï - –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ\n"
        "‚Ä¢ üîá –ó–ê–ì–õ–£–®–ò–¢–¨ - –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≥–ª—É—à–∏—Ç—å —ç—Ç–æ—Ç –∞—Å—Å–µ—Ç\n\n"
        "<b>Black Pack üñ§:</b>\n"
        "–§–æ–Ω—ã Black –∏ Black Onyx —Ç—Ä–µ–∫–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ\n"
        "–¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è.\n\n"
        "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞\n"
        "/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É –ø–æ–º–æ—â—å\n"
        "/features - üî• –í—Å–µ —Ñ–∏—á–∏ –∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –±–æ—Ç–∞\n"
        "/stats - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä—ã–Ω–∫–∞\n"
        "/onchain - ‚õìÔ∏è On-chain NFT —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–±–ª–æ–∫—á–µ–π–Ω)"
    )

    await message.answer(help_text, parse_mode="HTML")


async def cmd_features(message: Message):
    """Handle /features command - show all bot features and advantages."""
    # Whitelist check is handled by middleware
    features_text = (
        "<b>üöÄ AAA TON GIFTS SCANNER - –í–°–ï –§–ò–ß–ò</b>\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"

        "<b>üíé –ß–¢–û –î–ï–õ–ê–ï–¢ –ë–û–¢:</b>\n\n"
        "–≠—Ç–æ —Ç–≤–æ–π <b>–õ–ò–ß–ù–´–ô –ê–°–°–ò–°–¢–ï–ù–¢</b> –¥–ª—è —Ç—Ä–µ–π–¥–∏–Ω–≥–∞ TON Gifts.\n"
        "–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç <b>24/7</b>, —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –≤–µ—Å—å —Ä—ã–Ω–æ–∫, –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ—Ñ–∏—Ç–Ω—ã–µ –¥–∏–ª—ã "
        "–∏ —à–ª—ë—Ç —Ç–µ–±–µ –∞–ª–µ—Ä—Ç—ã <b>–ú–ì–ù–û–í–ï–ù–ù–û</b>.\n\n"

        "–¢—ã –Ω–µ —Ç—Ä–∞—Ç–∏—à—å –≤—Ä–µ–º—è –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ - –±–æ—Ç –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –ó–ê –¢–ï–ë–Ø! üî•\n\n"

        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"

        "<b>üß† –£–ú–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê:</b>\n\n"

        "<b>[1] ARP (Adaptive Reference Price)</b>\n"
        "   –ù–µ —Ç—É–ø–æ floor_2nd, –∞ –£–ú–ù–´–ô —Ä–∞—Å—á—ë—Ç:\n"
        "   ‚Ä¢ –ö–æ–º–±–∏–Ω–∞—Ü–∏—è floor —Ü–µ–Ω + –º–µ–¥–∏–∞–Ω—ã –ø—Ä–æ–¥–∞–∂\n"
        "   ‚Ä¢ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≤–µ—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏\n"
        "   ‚Ä¢ –®—Ç—Ä–∞—Ñ—ã –∑–∞ –Ω–∏–∑–∫—É—é –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –∏ –ø–∞–¥–∞—é—â–∏–π —Ç—Ä–µ–Ω–¥\n"
        "   <i>‚Üí –†–µ—Ñ–µ—Ä–µ–Ω—Å –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Ä—ã–Ω–æ–∫!</i>\n\n"

        "<b>[2] –õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å (0-10)</b>\n"
        "   ‚Ä¢ –ü—Ä–æ–¥–∞–∂–∏ –∑–∞ 7 –¥–Ω–µ–π √ó 2.0\n"
        "   ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç–∏–Ω–≥–æ–≤ √ó 0.5\n"
        "   ‚Ä¢ –ë–æ–Ω—É—Å –∑–∞ —Å–≤–µ–∂–∏–µ –ø—Ä–æ–¥–∞–∂–∏ (–¥–æ +2.0)\n"
        "   ‚Ä¢ –ë–æ–Ω—É—Å –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 30 –¥–Ω–µ–π (–¥–æ +1.0)\n"
        "   <i>‚Üí –¢—ã –≤–∏–¥–∏—à—å –Ω–∞—Å–∫–æ–ª—å–∫–æ –ª–µ–≥–∫–æ –ø—Ä–æ–¥–∞—Ç—å!</i>\n\n"

        "<b>[3] Hotness (0-10)</b>\n"
        "   ‚Ä¢ –ü–æ–∫—É–ø–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å √ó 5.0\n"
        "   ‚Ä¢ –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã √ó 2.0\n"
        "   ‚Ä¢ –õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å √ó 1.0\n"
        "   ‚Ä¢ –ë–æ–Ω—É—Å –∑–∞ –Ω–æ–≤—ã–π –ª–∏—Å—Ç–∏–Ω–≥ √ó 3.0\n"
        "   <i>‚Üí –¢—ã –≤–∏–¥–∏—à—å —á—Ç–æ –°–ï–ô–ß–ê–° –≥–æ—Ä—è—á–µ–µ!</i>\n\n"

        "<b>[4] Confidence Level</b>\n"
        "   ‚Ä¢ VERY HIGH: 10+ –ø—Ä–æ–¥–∞–∂ –∑–∞ 7–¥, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å ‚â•7\n"
        "   ‚Ä¢ HIGH: 5+ –ø—Ä–æ–¥–∞–∂, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å ‚â•5\n"
        "   ‚Ä¢ MEDIUM: 2+ –ø—Ä–æ–¥–∞–∂–∏, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å ‚â•3\n"
        "   ‚Ä¢ LOW: –æ—Å—Ç–∞–ª—å–Ω–æ–µ\n"
        "   <i>‚Üí –¢—ã –∑–Ω–∞–µ—à—å –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö!</i>\n\n"

        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"

        "<b>üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –õ–û–ñ–ù–´–• –ê–õ–ï–†–¢–û–í:</b>\n\n"

        "<b>5 –°–õ–û–Å–í –§–ò–õ–¨–¢–†–ê–¶–ò–ò:</b>\n\n"

        "<b>[1] –ë–∞–∑–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</b>\n"
        "   ‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω\n"
        "   ‚Ä¢ Black Pack —Ñ–∏–ª—å—Ç—Ä\n"
        "   ‚Ä¢ Clean only —Ä–µ–∂–∏–º\n\n"

        "<b>[2] Quality Gates</b>\n"
        "   ‚Ä¢ –û–¥–∏–Ω –ª–∏—Å—Ç–∏–Ω–≥ + LOW confidence ‚Üí 50%+ –ø—Ä–æ—Ñ–∏—Ç\n"
        "   ‚Ä¢ –ù–∏–∑–∫–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å + LOW confidence ‚Üí 35%+ –ø—Ä–æ—Ñ–∏—Ç\n"
        "   ‚Ä¢ –®—Ç—Ä–∞—Ñ –∑–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å &lt;5: —Ç—Ä–µ–±—É–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ—Ñ–∏—Ç–∞\n\n"

        "<b>[3] Anti-False-Positive</b>\n"
        "   ‚Ä¢ –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∏–ª—ã (&gt;70% –Ω–∞ –Ω–µ–ª–∏–∫–≤–∏–¥–µ) ‚Üí REJECT\n"
        "   ‚Ä¢ –°—Ç–∞—Ä—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏ (&gt;6 —á–∞—Å–æ–≤) ‚Üí REJECT\n"
        "   ‚Ä¢ –ß–∞—Å—Ç–∞—è —Å–º–µ–Ω–∞ —Ü–µ–Ω (‚â•3 –∑–∞ —á–∞—Å) ‚Üí REJECT\n"
        "   ‚Ä¢ Black Pack –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Üí REJECT\n\n"

        "<b>[4] –ö—É–ª–¥–∞—É–Ω—ã</b>\n"
        "   ‚Ä¢ 120 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –∞–ª–µ—Ä—Ç–∞–º–∏ –ø–æ –æ–¥–Ω–æ–º—É –∞–∫—Ç–∏–≤—É\n"
        "   ‚Ä¢ –ù–µ —Å–ø–∞–º–ª—é - —Ç–æ–ª—å–∫–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã\n\n"

        "<b>[5] Rate Limiting</b>\n"
        "   ‚Ä¢ –ú–∞–∫—Å 50 –∞–ª–µ—Ä—Ç–æ–≤ –≤ —á–∞—Å –Ω–∞ —é–∑–µ—Ä–∞\n"
        "   ‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏\n\n"

        "<i>‚Üí –¢—ã –ø–æ–ª—É—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –†–ï–ê–õ–¨–ù–´–ï –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏!</i>\n\n"

        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"

        "<b>‚ö° –°–ö–û–†–û–°–¢–¨ –†–ï–ê–ö–¶–ò–ò:</b>\n\n"

        "‚Ä¢ <b>Real-time —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</b> (Swift Gifts WebSocket)\n"
        "‚Ä¢ <b>–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç</b> –∞–Ω–∞–ª–∏—Ç–∏–∫–∏\n"
        "‚Ä¢ <b>–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞</b> –∞–ª–µ—Ä—Ç–∞\n\n"

        "<i>–¢—ã —É–∑–Ω–∞—ë—à—å –æ –¥–∏–ª–∞—Ö –Ω–∞ 5-10 –ú–ò–ù–£–¢ –†–ê–ù–¨–®–ï –¥—Ä—É–≥–∏—Ö!</i> üöÄ\n\n"

        "–ü–æ–∫–∞ –æ–Ω–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ª–∏—Å—Ç–∞—é—Ç ‚Üí "
        "—Ç—ã —É–∂–µ –ö–£–ü–ò–õ! üí∞\n\n"

        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"

        "<b>üéØ –ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø:</b>\n\n"

        "‚Ä¢ <b>Min Profit:</b> –æ—Ç 10% –¥–æ 50%\n"
        "‚Ä¢ <b>Price Range:</b> –æ—Ç 100 –¥–æ 10000 TON\n"
        "‚Ä¢ <b>Black Pack Only:</b> –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å\n"
        "‚Ä¢ <b>Clean Only:</b> —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–µ –Ω–æ–º–µ—Ä–∞\n"
        "‚Ä¢ <b>–†–µ–∂–∏–º—ã:</b> SPAM (–±–æ–ª—å—à–µ –∞–ª–µ—Ä—Ç–æ–≤) vs SNIPER (—Ç–æ–ª—å–∫–æ —Ç–æ–ø)\n\n"

        "<i>–ö–∞–∂–¥—ã–π –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ–¥ –°–í–û–Æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é!</i>\n\n"

        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"

        "<b>üñ§ BLACK PACK –¢–†–ï–ö–ò–ù–ì:</b>\n\n"

        "‚Ä¢ –û—Ç–¥–µ–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç floor —Ü–µ–Ω –¥–ª—è Black & Black Onyx\n"
        "‚Ä¢ –û—Ç–¥–µ–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Ñ–æ–Ω–æ–≤\n"
        "‚Ä¢ –¢–æ—á–Ω–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ\n"
        "‚Ä¢ –§–∏–ª—å—Ç—Ä \"—Ç–æ–ª—å–∫–æ Black Pack\"\n\n"

        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"

        "<b>üìä –ß–¢–û –≠–ö–û–ù–û–ú–ò–¢ –ë–û–¢:</b>\n\n"

        "<b>–ë–ï–ó –ë–û–¢–ê:</b>\n"
        "‚Ä¢ 2-3 —á–∞—Å–∞ –≤ –¥–µ–Ω—å –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n"
        "‚Ä¢ –ù–∞—Ö–æ–¥–∏—à—å 2-3 –¥–∏–ª–∞ –≤ –Ω–µ–¥–µ–ª—é –≤—Ä—É—á–Ω—É—é\n"
        "‚Ä¢ –£–ø—É—Å–∫–∞–µ—à—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞ —Å–ø–∏—à—å\n\n"

        "<b>–° –ë–û–¢–û–ú:</b>\n"
        "‚Ä¢ 10 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–ª–µ—Ä—Ç–æ–≤\n"
        "‚Ä¢ –ù–∞—Ö–æ–¥–∏—à—å 10-15 –¥–∏–ª–æ–≤ –≤ –Ω–µ–¥–µ–ª—é\n"
        "‚Ä¢ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7, –¥–∞–∂–µ –∫–æ–≥–¥–∞ —Ç—ã —Å–ø–∏—à—å\n\n"

        "<b>–≠–ö–û–ù–û–ú–ò–Ø:</b>\n"
        "‚Ä¢ <b>14+ —á–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é</b> —Ç–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏\n"
        "‚Ä¢ <b>3-5x –±–æ–ª—å—à–µ</b> –ø—Ä–æ—Ñ–∏—Ç–Ω—ã—Ö –¥–∏–ª–æ–≤\n"
        "‚Ä¢ <b>–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ</b> –≤ —Å–∫–æ—Ä–æ—Å—Ç–∏\n\n"

        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"

        "<b>üí™ –¢–í–û–ò –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:</b>\n\n"

        "‚úÖ <b>–ê–ö–¢–ò–í–ù–´–ô –ø–æ–º–æ—â–Ω–∏–∫</b> (–Ω–µ –ø–∞—Å—Å–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä)\n"
        "‚úÖ <b>–†–ê–ë–û–¢–ê–ï–¢ –ó–ê –¢–ï–ë–Ø</b> 24/7\n"
        "‚úÖ <b>–ú–ì–ù–û–í–ï–ù–ù–´–ï –∞–ª–µ—Ä—Ç—ã</b> (–±—ã—Å—Ç—Ä–µ–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤)\n"
        "‚úÖ <b>–£–ú–ù–ê–Ø —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è</b> (—Ç–æ–ª—å–∫–æ –∫–∞—á–µ—Å—Ç–≤–æ)\n"
        "‚úÖ <b>–ó–ê–©–ò–¢–ê –æ—Ç –ª–æ–∂–Ω—è–∫–æ–≤</b> (5 —Å–ª–æ—ë–≤)\n"
        "‚úÖ <b>–ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ï –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</b> (–ø–æ–¥ —Ç–≤–æ–π —Å—Ç–∏–ª—å)\n"
        "‚úÖ <b>–≠–ö–û–ù–û–ú–ò–Ø –≤—Ä–µ–º–µ–Ω–∏</b> (2+ —á–∞—Å–∞ –≤ –¥–µ–Ω—å)\n"
        "‚úÖ <b>–ë–û–õ–¨–®–ï –ø—Ä–æ—Ñ–∏—Ç–∞</b> (3-5x –¥–∏–ª–æ–≤)\n\n"

        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"

        "<b>üî• –ò–¢–û–ì–û:</b>\n\n"

        "–≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ \"–º–æ–Ω–∏—Ç–æ—Ä —Ü–µ–Ω\".\n"
        "–≠—Ç–æ <b>–ú–ê–®–ò–ù–ê –î–õ–Ø –ó–ê–†–ê–ë–û–¢–ö–ê</b>.\n\n"

        "–ë–æ—Ç –ù–ê–•–û–î–ò–¢ –¥–µ–Ω—å–≥–∏, –ø–æ–∫–∞ —Ç—ã —Å–ø–∏—à—å,\n"
        "—Ä–∞–±–æ—Ç–∞–µ—à—å –∏–ª–∏ –æ—Ç–¥—ã—Ö–∞–µ—à—å.\n\n"

        "–¢—ã –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å Telegram,\n"
        "–≤–∏–¥–∏—à—å –∞–ª–µ—Ä—Ç –∏ –ü–û–ö–£–ü–ê–ï–®–¨.\n\n"

        "<b>–ü–†–û–§–ò–¢ –ò–õ–ò –ù–ê–•–£–ô! üíéüöÄ</b>\n\n"

        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"

        "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞\n"
        "/help - –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è\n"
        "/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä—ã–Ω–∫–∞\n"
        "/features - –í—Å–µ —Ñ–∏—á–∏ (—ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ)"
    )

    await message.answer(features_text, parse_mode="HTML")


async def cmd_stats(message: Message):
    """Handle /stats command."""
    # Whitelist check is handled by middleware
    try:
        # Get statistics from database
        async for session in db.get_session():
            # Total events
            query = text("""
            SELECT
                COUNT(*) as total,
                SUM(CASE WHEN event_type = 'buy' THEN 1 ELSE 0 END) as buys,
                SUM(CASE WHEN event_type = 'listing' THEN 1 ELSE 0 END) as listings,
                SUM(CASE WHEN event_type = 'change_price' THEN 1 ELSE 0 END) as changes
            FROM market_events
            WHERE event_time >= NOW() - INTERVAL '24 hours'
            """)
            result = await session.execute(query)
            stats = result.fetchone()

            # Active listings
            query = text("SELECT COUNT(*) FROM active_listings")
            result = await session.execute(query)
            active_listings = result.scalar()

            # Black pack listings
            query = text("""
            SELECT COUNT(*) FROM active_listings
            WHERE backdrop IN ('Black', 'Black Onyx')
            """)
            result = await session.execute(query)
            black_pack_listings = result.scalar()

            # Average prices
            query = text("""
            SELECT
                AVG(price) as avg_listing,
                MIN(price) as min_listing,
                MAX(price) as max_listing
            FROM active_listings
            """)
            result = await session.execute(query)
            prices = result.fetchone()

        # Format prices safely (handle None values)
        avg_price = f"{prices[0]:.2f}" if prices[0] is not None else "N/A"
        min_price = f"{prices[1]:.2f}" if prices[1] is not None else "N/A"
        max_price = f"{prices[2]:.2f}" if prices[2] is not None else "N/A"

        stats_text = (
            "<b>üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–´–ù–ö–ê (24—á)</b>\n\n"
            f"<b>–°–æ–±—ã—Ç–∏—è:</b>\n"
            f"‚îú‚îÄ –í—Å–µ–≥–æ: {stats[0]:,}\n"
            f"‚îú‚îÄ üõí –ü–æ–∫—É–ø–æ–∫: {stats[1]:,}\n"
            f"‚îú‚îÄ üìã –õ–∏—Å—Ç–∏–Ω–≥–æ–≤: {stats[2]:,}\n"
            f"‚îî‚îÄ üí± –°–º–µ–Ω —Ü–µ–Ω: {stats[3]:,}\n\n"
            f"<b>–ê–∫—Ç–∏–≤–Ω—ã–π —Ä—ã–Ω–æ–∫:</b>\n"
            f"‚îú‚îÄ –í—Å–µ–≥–æ –ª–∏—Å—Ç–∏–Ω–≥–æ–≤: {active_listings:,}\n"
            f"‚îî‚îÄ üñ§ Black Pack: {black_pack_listings:,}\n\n"
            f"<b>–î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω:</b>\n"
            f"‚îú‚îÄ –°—Ä–µ–¥–Ω—è—è: {avg_price} TON\n"
            f"‚îú‚îÄ –°–∞–º–∞—è –Ω–∏–∑–∫–∞—è: {min_price} TON\n"
            f"‚îî‚îÄ –°–∞–º–∞—è –≤—ã—Å–æ–∫–∞—è: {max_price} TON\n\n"
            f"<i>–°–∫–∞–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7, –±–∞—Ä—ã–∂–∏–º –Ω–∞—Ö—É–π! üöÄ</i>"
        )

        await message.answer(stats_text, parse_mode="HTML")

    except Exception as e:
        logger.error(f"Error getting stats: {e}", exc_info=True)
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ, –±—Ä–æ.")


async def cmd_onchain(message: Message):
    """Handle /onchain command - show on-chain NFT statistics."""
    try:
        async for session in db.get_session():
            # Total on-chain events
            query = text("""
            SELECT
                COUNT(*) as total,
                SUM(CASE WHEN event_type = 'buy' THEN 1 ELSE 0 END) as buys,
                COUNT(DISTINCT gift_name) as collections
            FROM market_events
            WHERE source = 'ton_api'
            AND event_time >= NOW() - INTERVAL '24 hours'
            """)
            result = await session.execute(query)
            stats = result.fetchone()

            # Total on-chain events all time
            query = text("""
            SELECT COUNT(*) FROM market_events WHERE source = 'ton_api'
            """)
            result = await session.execute(query)
            total_all_time = result.scalar() or 0

            # Top collections by volume (24h)
            query = text("""
            SELECT gift_name, COUNT(*) as sales, AVG(price) as avg_price
            FROM market_events
            WHERE source = 'ton_api'
            AND event_type = 'buy'
            AND event_time >= NOW() - INTERVAL '24 hours'
            GROUP BY gift_name
            ORDER BY sales DESC
            LIMIT 5
            """)
            result = await session.execute(query)
            top_collections = result.fetchall()

        total_24h = stats[0] or 0
        buys_24h = stats[1] or 0
        collections_24h = stats[2] or 0

        onchain_text = (
            "<b>‚õìÔ∏è ON-CHAIN –°–¢–ê–¢–ò–°–¢–ò–ö–ê (NFT)</b>\n\n"
            "<b>‚ÑπÔ∏è –ß—Ç–æ —ç—Ç–æ:</b>\n"
            "On-chain - —ç—Ç–æ –ø–æ–¥–∞—Ä–∫–∏ Telegram, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏\n"
            "–≤—ã–≤–µ–¥–µ–Ω—ã –Ω–∞ –±–ª–æ–∫—á–µ–π–Ω TON –∫–∞–∫ NFT.\n"
            "–ò—Ö –º–æ–∂–Ω–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –Ω–∞ GetGems –∏ –¥—Ä—É–≥–∏—Ö\n"
            "NFT –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö.\n\n"
            f"<b>üìä –ó–∞ 24 —á–∞—Å–∞:</b>\n"
            f"‚îú‚îÄ –í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π: {total_24h:,}\n"
            f"‚îú‚îÄ üíé –ü—Ä–æ–¥–∞–∂ NFT: {buys_24h:,}\n"
            f"‚îî‚îÄ üìÅ –ö–æ–ª–ª–µ–∫—Ü–∏–π –∞–∫—Ç–∏–≤–Ω–æ: {collections_24h:,}\n\n"
            f"<b>üìà –í—Å–µ–≥–æ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è:</b>\n"
            f"‚îî‚îÄ –°–æ–±—ã—Ç–∏–π —Å–æ–±—Ä–∞–Ω–æ: {total_all_time:,}\n\n"
        )

        if top_collections:
            onchain_text += "<b>üî• –¢–æ–ø –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (24—á –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º):</b>\n"
            for i, (name, sales, avg_price) in enumerate(top_collections, 1):
                avg_str = f"{avg_price:.1f}" if avg_price else "N/A"
                onchain_text += f"{i}. {name}: {sales} –ø—Ä–æ–¥–∞–∂ (~{avg_str} TON)\n"
            onchain_text += "\n"

        onchain_text += (
            "<b>üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</b>\n"
            "‚Ä¢ TON API (tonapi.io)\n"
            "‚Ä¢ 40+ –∫–æ–ª–ª–µ–∫—Ü–∏–π Telegram Gifts NFT\n\n"
            "<i>~5% –ø–æ–¥–∞—Ä–∫–æ–≤ –≤—ã–≤–æ–¥—è—Ç—Å—è on-chain, –Ω–æ –∏–º–µ–Ω–Ω–æ\n"
            "–æ–Ω–∏ —Ç–æ—Ä–≥—É—é—Ç—Å—è –Ω–∞ –≤—Ç–æ—Ä–∏—á–Ω–æ–º —Ä—ã–Ω–∫–µ! üíé</i>"
        )

        await message.answer(onchain_text, parse_mode="HTML")

    except Exception as e:
        logger.error(f"Error getting on-chain stats: {e}", exc_info=True)
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ on-chain —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")
